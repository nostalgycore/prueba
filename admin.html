<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #fce4ec; /* Rosa muy suave */
            font-family: 'Montserrat', sans-serif;
        }
        h1, h2, h3, .btn, label {
            font-family: 'Fredoka', cursive;
        }
        
        .admin-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(217, 38, 213, 0.15);
            border: 2px solid #f8bbd0;
        }

        .form-label {
            color: #ad1457;
            font-weight: 600;
        }

        .btn-upload {
            background-color: #d926d5;
            color: white;
            border: none;
            transition: all 0.3s;
        }
        .btn-upload:hover {
            background-color: #b01eb0;
            color: white;
            transform: translateY(-2px);
        }

        .product-item {
            background: white;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid #ffc1e3;
            transition: transform 0.2s;
        }
        .product-item:hover {
            transform: scale(1.01);
            border-color: #d926d5;
        }
        
        .thumb-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #f8bbd0;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg bg-white shadow-sm sticky-top">
        <div class="container">
            <span class="navbar-brand text-danger fw-bold" style="font-family: 'Fredoka'; font-size: 1.5rem;">
                <i class="bi bi-gear-fill"></i> Panel Admin
            </span>
            <a href="index.html" class="btn btn-outline-danger rounded-pill">
                <i class="bi bi-box-arrow-right"></i> Ir a la Tienda
            </a>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row g-4">
            
            <div class="col-lg-5">
                <div class="admin-card p-4">
                    <h4 class="mb-4 text-center" style="color: #d926d5;">Nuevo Producto</h4>
                    
                    <form id="form-productos">
                        
                        <div class="mb-3">
                            <label class="form-label">Nombre del Producto</label>
                            <input type="text" class="form-control" id="nombre" placeholder="Ej: Alcancía Spiderman" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Categoría</label>
                            <select class="form-select" id="categoria" required>
                                <option value="" selected disabled>Selecciona una opción...</option>
                                </select>
                        </div>

                        <div class="mb-3 p-3 bg-light rounded-3 border">
                            <label class="form-label text-primary"><i class="bi bi-image"></i> Foto de Portada (Principal)</label>
                            <input type="file" class="form-control mb-2" id="img-principal" accept="image/*" required>
                            <div id="preview-principal" class="mt-2 text-center"></div>
                        </div>

                        <div class="mb-3 p-3 bg-light rounded-3 border">
                            <label class="form-label text-secondary"><i class="bi bi-images"></i> Fotos Galería (Opcionales)</label>
                            <input type="file" class="form-control mb-2" id="img-galeria" accept="image/*" multiple>
                            <small class="text-muted">Selecciona varias para el carrusel.</small>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-upload py-2 shadow fw-bold" id="btn-guardar">
                                <i class="bi bi-cloud-arrow-up-fill"></i> GUARDAR PRODUCTO
                            </button>
                        </div>
                        
                        <div class="progress mt-3 d-none" id="barra-progreso-container">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" role="progressbar" style="width: 100%">Subiendo...</div>
                        </div>

                    </form>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="admin-card p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0" style="color: #6a1b9a;">Inventario Actual</h4>
                        <span class="badge bg-secondary" id="contador-productos">0 productos</span>
                    </div>

                    <div id="lista-productos" style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                        <div class="text-center text-muted py-5">
                            <div class="spinner-border text-danger" role="status"></div>
                            <p class="mt-2">Cargando inventario...</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // --- TU NUEVA CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCNiUdX80_2hRH_EHOsVxiZqFeP2PYXVGY",
            authDomain: "manos-de-angel-1c692.firebaseapp.com",
            projectId: "manos-de-angel-1c692",
            storageBucket: "manos-de-angel-1c692.firebasestorage.app",
            messagingSenderId: "102505109232",
            appId: "1:102505109232:web:9c2af7b8845140d8ad9435",
            measurementId: "G-LHZ40QXQ2N"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // CLOUDINARY (Sigue siendo el mismo si no lo has cambiado)
        const CLOUD_NAME = "dbxmnnlar";      
        const UPLOAD_PRESET = "unsigned";

        // Referencias
        const form = document.getElementById('form-productos');
        const listaProductos = document.getElementById('lista-productos');
        const barraProgreso = document.getElementById('barra-progreso-container');
        
        // LAS 29 CATEGORÍAS
        const categorias = [
            "Caricaturas", "Mascotas", "Lunetas", "Superhéroes", "Fútbol", 
            "Tamaños", "Princesas", "Halloween", "Unicornio", "Anime", 
            "Navidad", "Especiales", "Dinosaurios", "Oficios Profesiones", "Disfraces", 
            "Animales", "Novios", "Ceremonia", "Graduación", "Publicidad", 
            "Centros", "Fantasía", "Metas",
            "Bautizo", "Comunión", "XV Años", "Deportes", "Música", "Retro" 
        ];

        const selectCat = document.getElementById('categoria');
        categorias.sort().forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.text = cat;
            selectCat.appendChild(option);
        });

        // Preview Imagen Principal
        document.getElementById('img-principal').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const container = document.getElementById('preview-principal');
            container.innerHTML = '';
            if(file){
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.style.height = '100px';
                img.style.borderRadius = '10px';
                container.appendChild(img);
            }
        });

        // SUBIR A CLOUDINARY
        async function subirImagen(file) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);

            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                    method: "POST",
                    body: formData
                });
                const data = await res.json();
                return data.secure_url;
            } catch (error) {
                console.error("Error subiendo imagen:", error);
                return null;
            }
        }

        // GUARDAR PRODUCTO
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const btnGuardar = document.getElementById('btn-guardar');
            btnGuardar.disabled = true;
            btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';
            barraProgreso.classList.remove('d-none');

            try {
                const nombre = document.getElementById('nombre').value.trim();
                const categoria = document.getElementById('categoria').value;
                
                // Subir Principal
                const filePrincipal = document.getElementById('img-principal').files[0];
                let urlPrincipal = "";
                if (filePrincipal) urlPrincipal = await subirImagen(filePrincipal);

                // Subir Galería
                const filesGaleria = document.getElementById('img-galeria').files;
                let urlsGaleria = [];
                if (filesGaleria.length > 0) {
                    for (let i = 0; i < filesGaleria.length; i++) {
                        const url = await subirImagen(filesGaleria[i]);
                        if(url) urlsGaleria.push(url);
                    }
                }

                // Guardar en Firebase (Ahora usamos la colección 'productos' simple, ya que el proyecto es exclusivo)
                await addDoc(collection(db, "productos"), {
                    nombre: nombre,
                    categoria: categoria,
                    imagenPrincipal: urlPrincipal,
                    galeria: urlsGaleria,
                    fecha: serverTimestamp()
                });

                alert("¡Producto guardado!");
                form.reset();
                document.getElementById('preview-principal').innerHTML = '';

            } catch (error) {
                console.error("Error:", error);
                alert("Error al guardar. Revisa la consola (F12) por si hay errores de permisos.");
            } finally {
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = '<i class="bi bi-cloud-arrow-up-fill"></i> GUARDAR PRODUCTO';
                barraProgreso.classList.add('d-none');
            }
        });

        // LEER PRODUCTOS
        const q = query(collection(db, "productos"), orderBy("fecha", "desc"));

        onSnapshot(q, (snapshot) => {
            listaProductos.innerHTML = "";
            document.getElementById('contador-productos').innerText = `${snapshot.docs.length} productos`;

            snapshot.forEach((doc) => {
                const prod = doc.data();
                const id = doc.id;

                listaProductos.innerHTML += `
                    <div class="product-item p-3 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <img src="${prod.imagenPrincipal}" class="thumb-img me-3" alt="Foto">
                            <div>
                                <h6 class="mb-0 fw-bold" style="color: #6a1b9a;">${prod.nombre}</h6>
                                <small class="text-muted d-block">${prod.categoria}</small>
                                ${prod.galeria && prod.galeria.length > 0 ? 
                                    `<span class="badge bg-info text-dark rounded-pill mt-1" style="font-size:0.7rem">+${prod.galeria.length} fotos extra</span>` : ''}
                            </div>
                        </div>
                        <button class="btn btn-outline-danger btn-sm rounded-circle" onclick="window.eliminarProducto('${id}')">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>
                `;
            });
        });

        window.eliminarProducto = async (id) => {
            if(confirm("¿Borrar producto?")) {
                await deleteDoc(doc(db, "productos", id));
            }
        };
    </script>
</body>
</html>